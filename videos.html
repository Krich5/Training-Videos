<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Training Videos</title>
<meta name="color-scheme" content="dark">
<style>
  :root {
    --bg:#0b1020; --card:#131a2a; --muted:#92a0b8; --fg:#e9edf5; --input:#0e1525;
    --border:rgba(255,255,255,.08); --accentA:#22d3ee; --accentB:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui;background:#0b1020;color:#e9edf5;min-height:100vh}
  header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
  .btnLink{background:var(--input);color:var(--fg);border:1px solid var(--border);font-weight:800;padding:8px 14px;border-radius:12px;text-decoration:none}
  .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1,h2{margin:6px 0 12px 0}
  .muted{color:var(--muted)}
  video{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px}
  ul{list-style:none;margin:0;padding:0}
  .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input);margin-bottom:8px;cursor:pointer}
  .item.active{outline:2px solid var(--accentB)}
  .badge{font-size:.8rem;color:var(--muted)}
  .btn{background:linear-gradient(135deg,var(--accentA),var(--accentB));border:none;color:#06111d;font-weight:800;padding:8px 14px;border-radius:10px;cursor:pointer}
  .progWrap{margin-top:12px;background:#0e1525;border:1px solid var(--border);border-radius:999px;overflow:hidden;height:10px}
  .progBar{height:100%;width:0%;background:linear-gradient(90deg,var(--accentA),var(--accentB));transition:width .25s}
  .hint{font-size:.85rem;color:var(--muted);margin-top:8px}
</style>
<script src="config.js?v=v1"></script>
</head>
<body>
  <header>
    <a class="btnLink" href="index.html">← Back</a>
    <div style="font-weight:800" id="hdr">Training Videos</div>
    <div></div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h2 id="courseTitle" class="muted">Loading…</h2>
        <video id="player" controls playsinline></video>
        <div class="progWrap"><div id="overallBar" class="progBar"></div></div>
        <div id="overallHint" class="hint"></div>
      </section>
      <aside class="card">
        <h2>Playlist</h2>
        <ul id="list"></ul>
        <div id="status" class="muted"></div>
      </aside>
    </div>
  </div>

<script>
const { SCRIPT_URL, BRAND } = window.APP_CONFIG || {};
if (BRAND) document.getElementById('hdr').textContent = BRAND;

// ---- User context ----
const user = (()=>{ try{ return JSON.parse(sessionStorage.getItem('tp_user')||'null'); }catch{ return null; }})();
if(!user){ location.href='index.html'; }

// ---- Playlists ----
function playlistFor(course){
  if(course === 'agent'){
    return [
      { title:'Agent login',         src:'AgentVideos/Agent%20Login%20(Desktop).mp4' },
      { title:'Profile settings',    src:'AgentVideos/Profiles%20Settings.mp4' },
      { title:'Agent state',         src:'AgentVideos/Agent%20State.mp4' },
      { title:'Outbound calling',    src:'AgentVideos/Outbound%20Calling.mp4' },
      { title:'Side navigation',     src:'AgentVideos/Side%20Navigation.mp4' },
      { title:'Sign out',            src:'AgentVideos/Sign%20Out.mp4' }
    ];
  }
  if(course === 'supervisor'){ return [{ title:'Supervisor intro', src:'SupVideos/IMG_3339.mov' }]; }
  if(course === 'admin'){ return [{ title:'Admin intro', src:'AdminVideos/intro.mp4' }]; }
  return [];
}

// ---- UI refs ----
const listEl   = document.getElementById('list');
const statusEl = document.getElementById('status');
const player   = document.getElementById('player');
const courseTitle = document.getElementById('courseTitle');
const overallBar = document.getElementById('overallBar');
const overallHint = document.getElementById('overallHint');

// ---- State ----
const vids = playlistFor(user.course);
let idx = 0;
let finished = new Array(vids.length).fill(false);
// Fast-forward guard per video
let maxAllowedTime = 0;      // seconds
let seekingGuard = false;    // ignore re-entrant seeks

courseTitle.textContent = `${user.company} — ${user.course[0].toUpperCase()+user.course.slice(1)} Training`;

// ---- Render playlist ----
function renderList(){
  listEl.innerHTML = vids.map((v,i)=>`
    <li class="item ${i===idx?'active':''}" data-i="${i}">
      <span>${i+1}. ${v.title}</span>
      <span class="badge">${finished[i] ? 'done' : ''}</span>
    </li>`).join('');
  listEl.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click', ()=>{
      const i = Number(el.getAttribute('data-i'));
      // allow jumping only to already-finished or current item
      if (i <= idx || finished[i-1] === true) {
        idx = i;
        loadCurrent(true);
      }
    });
  });

  const doneCount = finished.filter(Boolean).length;
  statusEl.textContent = `${doneCount}/${vids.length} completed`;
  const pct = vids.length ? (doneCount / vids.length) * 100 : 0;
  overallBar.style.width = pct.toFixed(1)+'%';
  overallHint.textContent = `Overall progress: ${Math.round(pct)}%`;
}

// ---- Load current video & reset guard ----
function loadCurrent(autoplay){
  player.src = vids[idx].src;
  // reset fast-forward guard
  maxAllowedTime = 0;
  player.currentTime = 0;
  if (autoplay) player.play();
  renderList();
}

// ---- Enforce no fast-forward beyond watched ----
player.addEventListener('timeupdate', ()=>{
  if (player.currentTime > maxAllowedTime) {
    // track forward progress only when actually playing forward
    maxAllowedTime = player.currentTime;
  }
});
player.addEventListener('seeking', ()=>{
  if (seekingGuard) return;
  // allow seeking backward anywhere; block forward beyond maxAllowedTime
  if (player.currentTime > maxAllowedTime + 0.5) {
    seekingGuard = true;
    player.currentTime = maxAllowedTime;
    seekingGuard = false;
  }
});

// ---- On ended: mark complete, advance, and log when all done ----
player.addEventListener('ended', ()=>{
  finished[idx] = true;

  const allDone = finished.every(Boolean);
  if (allDone){
    const videos_json = vids.map((v,i)=>({ index:i, title:v.title, src:v.src }));
    if (SCRIPT_URL){
      fetch(SCRIPT_URL, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          mode:'completion',
          name:user.name,
          course:user.course,
          company:user.company,
          ts_client: new Date().toISOString(),
          page:'videos',
          ua: navigator.userAgent,
          videos_json
        })
      }).catch(()=>{});
    }
  }

  // Move to the next video (if any)
  if (idx < vids.length - 1){
    idx++;
    loadCurrent(true);
  }
  renderList();
});

// ---- Boot ----
if (!vids.length){
  courseTitle.textContent = `${user.company} — ${user.course} Training`;
  statusEl.textContent = 'No videos assigned for this course yet.';
} else {
  loadCurrent(false);
  renderList();
}
</script>
</body>
</html>
