<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Training Videos</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg:#0b1020; --bg2:#0a132a; --card:#131a2a; --muted:#92a0b8; --fg:#e9edf5;
  --input:#0e1525; --border:rgba(255,255,255,.08); --accentA:#22d3ee; --accentB:#3b82f6;
}
:root[data-theme="light"]{ --bg:#f6f7fb; --bg2:#eef2f8; --card:#ffffff; --fg:#0f172a; --input:#f3f4f6; --border:rgba(15,23,42,.12); --muted:#64748b; }
*{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);min-height:100vh;}
header{padding:14px 18px;border-bottom:1px solid var(--border)}
.hgrid{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
.left{justify-self:start}.center{justify-self:center}.right{justify-self:end}
.brand{font-weight:800;letter-spacing:.2px}
.btnLink{background:var(--input);color:var(--fg);border:1px solid var(--border);font-weight:800;padding:8px 14px;border-radius:12px;text-decoration:none}
.toggle{border:1px solid var(--border);background:var(--input);padding:6px 10px;border-radius:999px;cursor:pointer}
main{max-width:1100px;margin:24px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:18px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{margin:6px 0 12px 0}
.video{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px}
li{list-style:none;margin:0;padding:0}
.item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input);margin-bottom:8px;cursor:pointer}
.item.active{outline:2px solid var(--accentB)}
.badge{font-size:.8rem;color:var(--muted)}
</style>
<script src="config.js?v=31"></script>
<script>
(function themeBoot(){
  const saved = localStorage.getItem('tp_theme');
  if(saved) document.documentElement.setAttribute('data-theme', saved);
})();
</script>
</head>
<body>
<header>
  <div class="hgrid">
    <div class="left"><a class="btnLink" href="home.html">← Back</a></div>
    <div class="center"><div class="brand">Training Videos</div></div>
    <div class="right">
      <button id="themeBtn" class="toggle">Dark</button>
      <img src="CX%20Advanced%20Solutions_Smaller_white.png" alt="Logo" style="height:36px;margin-left:8px">
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2 id="courseTitle"></h2>
      <video id="player" class="video" controls playsinline></video>
    </section>
    <section class="card">
      <h2>Playlist</h2>
      <ul id="list" style="margin:0;padding:0"></ul>
    </section>
  </div>
</main>

<script>
const cfg = window.APP_CONFIG;
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const nxt = cur==='dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', nxt);
  localStorage.setItem('tp_theme', nxt);
  document.getElementById('themeBtn').textContent = nxt==='dark'?'Dark':'Light';
});
document.getElementById('themeBtn').textContent =
  (document.documentElement.getAttribute('data-theme')||'dark')==='dark'?'Dark':'Light';

const user = (()=>{ try{ return JSON.parse(sessionStorage.getItem('tp_user')||'null'); }catch{ return null; }})();
if(!user) { location.href='home.html'; }

/* Define course playlists (adjust paths/names as in your repo) */
function playlistFor(course){
  if(course==='agent'){
    return [
      { title:'Agent login',         src:'AgentVideos/Agent%20Login%20(Desktop).mp4' },
      { title:'Profile settings',    src:'AgentVideos/Profiles%20Settings.mp4' },
      { title:'Agent state',         src:'AgentVideos/Agent%20State.mp4' },
      { title:'Outbound calling',    src:'AgentVideos/Outbound%20Calling.mp4' },
      { title:'Side navigation',     src:'AgentVideos/Side%20Navigation.mp4' },
      { title:'Sign out',            src:'AgentVideos/Sign%20Out.mp4' }
    ];
  }
  if(course==='supervisor'){
    return [
      { title:'Supervisor intro', src:'SupVideos/IMG_3339.mov' }
    ];
  }
  if(course==='admin'){
    return [
      { title:'Admin intro', src:'AdminVideos/intro.mp4' }
    ];
  }
  return [];
}

const vids = playlistFor(user.course);
const list = document.getElementById('list');
const player = document.getElementById('player');
const courseTitle = document.getElementById('courseTitle');
courseTitle.textContent = `${user.company} — ${user.course.charAt(0).toUpperCase()+user.course.slice(1)} Training`;

let idx = 0, finished = new Array(vids.length).fill(false), jumping = false;

function renderList(){
  list.innerHTML = vids.map((v,i)=>`
    <li class="item ${i===idx?'active':''}" data-i="${i}">
      <span>${i+1}. ${v.title}</span>
      <span class="badge">${finished[i]?'done':''}</span>
    </li>`).join('');
  list.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click', ()=>{
      const i = Number(el.getAttribute('data-i'));
      if(i===idx) { player.currentTime = 0; player.play(); return; }
      idx = i; loadCurrent(true);
    });
  });
}
function loadCurrent(autoplay){
  jumping = true;
  player.src = vids[idx].src;
  player.currentTime = 0;
  if(autoplay) player.play();
  renderList();
  setTimeout(()=> jumping=false, 200); // guard against spurious "ended" on some mobiles
}
player.addEventListener('ended', ()=>{
  if(jumping) return;
  finished[idx] = true;
  const allDone = finished.every(Boolean);
  if(allDone){
    // send completion once
    const videos_json = vids.map((v,i)=>({ index:i, title:v.title, src:v.src }));
    fetch(cfg.SCRIPT_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        mode:'completion', name:user.name, course:user.course, company:user.company,
        ts_client: Date.now(), page:'videos', ua:navigator.userAgent, videos_json
      })
    }).catch(()=>{});
  }
  if(idx < vids.length-1){ idx++; loadCurrent(true); }
});
loadCurrent(false);
renderList();
</script>
</body>
</html>
