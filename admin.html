<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Training Admin</title>
<meta name="color-scheme" content="dark">
<style>
:root{
  --bg:#0b1020; --card:#131a2a; --muted:#92a0b8; --fg:#e9edf5;
  --accentA:#22d3ee; --accentB:#3b82f6; --input:#0e1525; --border:rgba(255,255,255,.08);
}
*,*::before,*::after{box-sizing:border-box}
body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
  background:var(--bg); color:var(--fg); min-height:100vh; }
header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06)}
.wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
.left{justify-self:start}.center{justify-self:center;text-align:center}.right{justify-self:end}
.brand{font-weight:800;letter-spacing:.2px;font-size:1.1rem}.logo{height:36px}
.btnLink{background:var(--input);color:var(--fg);border:1px solid var(--border);font-weight:800;padding:8px 14px;border-radius:12px;text-decoration:none}
main{max-width:1100px;margin:28px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,select{border-radius:10px;border:1px solid var(--border);background:var(--input);color:#e9edf5;padding:10px 12px;outline:none}
.btn{background:linear-gradient(135deg,var(--accentA),var(--accentB));border:none;color:#06111d;font-weight:800;padding:10px 18px;border-radius:12px;cursor:pointer}
.btn.secondary{background:var(--input);color:var(--fg);border:1px solid var(--border)}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;min-width:900px}
th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
th{position:sticky;top:0;background:#0e1525;z-index:1;text-transform:capitalize}
.muted{color:var(--muted)}.error{color:#f87171;font-weight:700;text-align:center}
.action{display:flex;gap:8px}.badge{font-size:.85rem;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="left"><a class="btnLink" href="index.html">← Back</a></div>
    <div class="center"><div class="brand">Training Admin</div></div>
    <div class="right"><img src="CX%20Advanced%20Solutions_Smaller_white.png" class="logo" alt="logo"></div>
  </div>
</header>

<main>
  <!-- Admin Gate -->
  <section id="gate" class="card">
    <div class="row" style="justify-content:center">
      <label for="adminPass" class="muted">Admin password</label>
      <input id="adminPass" type="password" placeholder="Enter admin password" autocomplete="off" spellcheck="false">
      <button id="adminBtn" class="btn">Sign in</button>
    </div>
    <div id="gateErr" class="error"></div>
  </section>

  <!-- Customers -->
  <section id="customers" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="addCompanyBtn" class="btn">Add customer</button>
        <button id="refreshCustomersBtn" class="btn secondary">Refresh</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr><th>Customer</th><th>Agent Code</th><th>Supervisor Code</th><th>Admin Code</th><th>Actions</th></tr>
        </thead>
        <tbody id="custBody"><tr><td colspan="5" style="padding:18px" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- Logs -->
  <section id="panel" class="card" style="display:none;margin-top:18px">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <select id="typeFilter">
          <option value="">All types</option>
          <option value="signin">Signin</option>
          <option value="completion">Completion</option>
        </select>
        <input id="courseFilter" placeholder="Course (e.g., agent)">
        <input id="search" placeholder="Search name/company">
        <button id="refresh" class="btn secondary">Refresh</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr><th>Time</th><th>Type</th><th>User</th><th>Course</th><th>Company</th><th>Videos Completed</th></tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script src="config.js?v=v1"></script>
<script>
const { SCRIPT_URL, ADMIN_TOKEN, ADMIN_PASS } = window.APP_CONFIG || {};

const gate = document.getElementById("gate"),
      customers = document.getElementById("customers"),
      panel = document.getElementById("panel"),
      gateErr = document.getElementById("gateErr");

function showApp(){ gate.style.display="none"; customers.style.display=""; panel.style.display=""; loadCustomers(); loadLogs(); }
function showGate(){ gate.style.display=""; customers.style.display="none"; panel.style.display="none"; }

// Login button
document.getElementById("adminBtn").addEventListener("click", ()=>{
  const v = document.getElementById("adminPass").value.trim();
  gateErr.textContent = "";
  if (v === ADMIN_PASS) { showApp(); }
  else { gateErr.textContent = "Incorrect password."; }
});
// Enter key submits password
document.getElementById("adminPass").addEventListener("keydown", (e)=>{
  if (e.key === "Enter") { e.preventDefault(); document.getElementById("adminBtn").click(); }
});

// --- CUSTOMERS ---
const custBody = document.getElementById("custBody");
document.getElementById("refreshCustomersBtn").addEventListener("click", loadCustomers);

// Use GET (no preflight) to add a customer
document.getElementById("addCompanyBtn").addEventListener("click", async ()=>{
  const name = prompt("Customer name"); if (!name) return;
  try{
    const url = `${SCRIPT_URL}?mode=addcompany&token=${encodeURIComponent(ADMIN_TOKEN)}&company=${encodeURIComponent(name)}`;
    const res = await fetch(url);
    const text = await res.text(); let data; try{ data = JSON.parse(text); }catch{ data = null; }
    if(!res.ok || !data || data.ok !== true){
      alert(text === "UNAUTHORIZED" ? "Token mismatch — check SECRET_TOKEN" : "Server error: " + text);
      return;
    }
    await loadCustomers();
    alert(`Codes for "${data.company}":\nAgent: ${data.agent}\nSupervisor: ${data.supervisor}\nAdmin: ${data.admin}`);
  }catch{ alert("Network error"); }
});

async function loadCustomers(){
  custBody.innerHTML = `<tr><td colspan="5" style="padding:18px" class="muted">Loading…</td></tr>`;
  try{
    const url = `${SCRIPT_URL}?mode=customers&token=${encodeURIComponent(ADMIN_TOKEN)}`;
    const res = await fetch(url); const text = await res.text();
    if(!res.ok){ custBody.innerHTML = `<tr><td colspan="5" class="error">HTTP ${res.status}</td></tr>`; return; }
    if(text === "UNAUTHORIZED"){ custBody.innerHTML = `<tr><td colspan="5" class="error">UNAUTHORIZED — token mismatch.</td></tr>`; return; }
    const data = JSON.parse(text); const rows = (data && data.rows) ? data.rows : [];
    if(!rows.length){ custBody.innerHTML = `<tr><td colspan="5" class="muted">No customers yet.</td></tr>`; return; }
    custBody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r.company||""}</td>
        <td><code>${r.agent_code||""}</code></td>
        <td><code>${r.supervisor_code||""}</code></td>
        <td><code>${r.admin_code||""}</code></td>
        <td class="action"><button class="btn secondary" data-revoke="${r.agent_code||""}">Revoke</button></td>
      </tr>`).join('');

    // bind revoke (GET ?mode=revoke&agent=CODE)
    document.querySelectorAll('[data-revoke]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const agent = btn.getAttribute('data-revoke');
        if (!agent) return;
        if (!confirm(`Revoke and remove access for agent code "${agent}"?`)) return;
        try{
          const url = `${SCRIPT_URL}?mode=revoke&token=${encodeURIComponent(ADMIN_TOKEN)}&agent=${encodeURIComponent(agent)}`;
          const res = await fetch(url);
          const raw = await res.text(); let data; try{ data = JSON.parse(raw); }catch{ data = null; }
          if(!res.ok || !data || data.ok !== true){ alert(raw||"Server error"); return; }
          await loadCustomers();
        }catch{ alert("Network error"); }
      });
    });
  }catch{ custBody.innerHTML = `<tr><td colspan="5" class="error">Network error</td></tr>`; }
}

// --- LOGS ---
const tbody = document.getElementById("tbody"),
      typeFilter = document.getElementById("typeFilter"),
      courseFilter = document.getElementById("courseFilter"),
      search = document.getElementById("search");
document.getElementById("refresh").addEventListener("click", loadLogs);
let allRows = [];
async function loadLogs(){
  tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr>`;
  try{
    const url = `${SCRIPT_URL}?mode=json&token=${encodeURIComponent(ADMIN_TOKEN)}&limit=2000`;
    const res = await fetch(url); const text = await res.text();
    if(!res.ok){ tbody.innerHTML = `<tr><td colspan="6" class="error">HTTP ${res.status}</td></tr>`; return; }
    if(text === "UNAUTHORIZED"){ tbody.innerHTML = `<tr><td colspan="6" class="error">UNAUTHORIZED</td></tr>`; return; }
    const data = JSON.parse(text);
    allRows = (data && data.rows) ? data.rows : [];
    // newest first
    allRows.sort((a,b)=> new Date(b.ts_server) - new Date(a.ts_server));
    renderLogs();
  }catch{ tbody.innerHTML = `<tr><td colspan="6" class="error">Failed to load logs.</td></tr>`; }
}
function renderLogs(){
  const t = s => (s==null||s==="") ? "" : String(s);
  const q = search.value.trim().toLowerCase(),
        tf = typeFilter.value.trim().toLowerCase(),
        cf = courseFilter.value.trim().toLowerCase();
  const rows = allRows.filter(r=>{
    const okType = !tf || t(r.type).toLowerCase()===tf;
    const okCourse = !cf || t(r.course).toLowerCase().includes(cf);
    const text = (t(r.name)+" "+t(r.company)).toLowerCase();
    return okType && okCourse && (!q || text.includes(q));
  });
  if(!rows.length){ tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px">No rows.</td></tr>`; return; }
  tbody.innerHTML = rows.map(r=>{
    let vidsDisplay = "";
    if (r.videos_json) {
      try { vidsDisplay = JSON.parse(r.videos_json).map(x=>x.title||x.src||"").join(", "); }
      catch { vidsDisplay = r.videos_json; }
    }
    const timeStr = r.ts_server ? new Date(r.ts_server).toLocaleString("en-US",{month:"numeric",day:"numeric",year:"2-digit",hour:"numeric",minute:"2-digit"}) : "";
    return `<tr>
      <td>${timeStr}</td>
      <td>${r.type||""}</td>
      <td>${r.name||""}</td>
      <td>${r.course||""}</td>
      <td>${r.company||""}</td>
      <td>${vidsDisplay||""}</td>
    </tr>`;
  }).join("");
}
</script>
</body>
</html>
