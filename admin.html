<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Training Admin</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#0b1020; --card:#131a2a; --muted:#92a0b8; --fg:#e9edf5;
      --accentA:#22d3ee; --accentB:#3b82f6; --border:rgba(255,255,255,.08);
      --input:#0e1525;
    }
    /* Light theme */
    :root[data-theme="light"]{
      --bg:#f5f7fb; --card:#ffffff; --muted:#5f6b7a; --fg:#0d1321;
      --accentA:#60a5fa; --accentB:#22d3ee; --border:rgba(0,0,0,.12);
      --input:#f3f6fb;
    }

    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans";background:var(--bg);color:var(--fg);min-height:100vh}

    header{padding:14px 18px;border-bottom:1px solid var(--border)}
    .wrap{max-width:1300px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px}
    .left{justify-self:start}
    .center{justify-self:center;text-align:center}
    .right{justify-self:end;display:flex;gap:10px;align-items:center}

    .brand{font-weight:800;letter-spacing:.2px}
    .logo{height:36px}
    .btnLink{background:var(--input);color:var(--fg);border:1px solid var(--border);font-weight:800;padding:8px 14px;border-radius:12px;text-decoration:none}

    .btn{background:linear-gradient(135deg,var(--accentA),var(--accentB));border:none;color:#06111d;font-weight:800;padding:10px 18px;border-radius:12px;cursor:pointer}
    .btn.secondary{background:var(--input);color:var(--fg);border:1px solid var(--border)}
    .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--fg)}

    main{max-width:1300px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.12)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    input,select{border-radius:10px;border:1px solid var(--border);background:var(--input);color:#e9edf5;padding:10px 12px;outline:none}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
    th{position:sticky;top:0;background:var(--input);z-index:1}

    .muted{color:var(--muted)}
    .pill{font-size:.85rem;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--input)}
    .centerBox{display:flex;justify-content:center}
    .error{color:#f87171;font-weight:700}

    .toggle{border:1px solid var(--border);background:var(--input);color:var(--fg);border-radius:999px;padding:6px 12px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="left"><a class="btnLink" href="index.html">← Back</a></div>
      <div class="center"><div class="brand">Training Admin</div></div>
      <div class="right">
        <button id="themeBtn" class="toggle" title="Toggle theme">Dark</button>
        <button id="logoutHeader" class="btn">Log out</button>
        <img src="CX%20Advanced%20Solutions_Smaller_white.png" alt="CX Advanced Solutions" class="logo"/>
      </div>
    </div>
  </header>

  <main>
    <!-- Admin password entry -->
    <section id="gate" class="card">
      <div class="centerBox">
        <div class="row">
          <label class="muted">Admin password</label>
          <input id="adminPass" type="password" placeholder="Enter admin password"/>
          <button id="adminBtn" class="btn">Sign in</button>
        </div>
      </div>
      <div class="centerBox"><div id="gateErr" class="error" style="margin-top:8px"></div></div>
    </section>

    <!-- Companies list -->
    <section id="customers" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="addCompanyBtn" class="btn">Add company</button>
          <button id="refreshCustomersBtn" class="btn secondary">Refresh</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Company</th><th>Agent code</th><th>Supervisor code</th><th>Admin code</th><th>Active</th><th>Created</th>
            </tr>
          </thead>
          <tbody id="custBody">
            <tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Training logs -->
    <section id="panel" class="card" style="display:none;margin-top:18px">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">Rows: <span id="rowCount">0</span></span>
          <select id="typeFilter">
            <option value="">All types</option>
            <option value="signin">signin</option>
            <option value="completion">completion</option>
          </select>
          <input id="courseFilter" placeholder="Course (e.g., agent)"/>
          <input id="search" placeholder="Search name/company/video"/>
          <button id="refresh" class="btn secondary">Refresh</button>
          <button id="downloadCsv" class="btn secondary">Download CSV</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>time (EST)</th>
              <th>Type</th>
              <th>User</th>
              <th>Course</th>
              <th>Company</th>
              <th>Video’s Completed</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Shared config -->
  <script src="config.js"></script>
  <script>
  const { SCRIPT_URL, ADMIN_TOKEN, ADMIN_PASS } = window.APP_CONFIG || {};

  // --- Theme toggle (persist to localStorage) ---
  const root = document.documentElement;
  const themeBtn = document.getElementById('themeBtn');
  function applyTheme(t){ root.setAttribute('data-theme', t); themeBtn.textContent = (t==='light'?'Light':'Dark'); }
  const savedTheme = localStorage.getItem('tv_theme') || 'dark';
  applyTheme(savedTheme);
  themeBtn.addEventListener('click', ()=>{
    const next = (root.getAttribute('data-theme') === 'light') ? 'dark' : 'light';
    applyTheme(next);
    localStorage.setItem('tv_theme', next);
  });

  // --- Auth gate (always require password; no session cache) ---
  const gate=document.getElementById('gate'),panel=document.getElementById('panel'),customers=document.getElementById('customers');
  const gateErr=document.getElementById('gateErr');
  function showApp(){ gate.style.display='none'; customers.style.display=''; panel.style.display=''; loadCustomers(); loadLogs(); }
  function showGate(){ gate.style.display=''; customers.style.display='none'; panel.style.display='none'; }
  document.getElementById('adminBtn').addEventListener('click',()=>{
    const val=document.getElementById('adminPass').value.trim();
    gateErr.textContent = "";
    if(val===ADMIN_PASS){ showApp(); }
    else { gateErr.textContent="Incorrect password."; }
  });
  document.getElementById('logoutHeader').addEventListener('click', ()=> location.href='index.html' );
  showGate(); // always start at login

  // --- Customers ---
  const custBody=document.getElementById('custBody');
  document.getElementById('refreshCustomersBtn').onclick=loadCustomers;
  document.getElementById('addCompanyBtn').onclick=async()=>{
    const name=prompt('Company name'); if(!name) return;
    try{
      const res=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'addCompany',token:ADMIN_TOKEN,company:name})});
      const text=await res.text(); let data; try{data=JSON.parse(text);}catch{}
      if(!res.ok||!data||data.ok!==true){ alert(text==='UNAUTHORIZED'?'Token mismatch or old deployment.\nMake sure ADMIN_TOKEN === SECRET_TOKEN and redeploy.':'Server error: '+text); return; }
      await loadCustomers();
      alert(`Codes for "${data.company}":\nAgent: ${data.agent}\nSupervisor: ${data.supervisor}\nAdmin: ${data.admin}`);
    }catch(e){ alert('Network error'); }
  };

  async function loadCustomers(){
    custBody.innerHTML=`<tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr>`;
    try{
      const url=`${SCRIPT_URL}?mode=customers&token=${encodeURIComponent(ADMIN_TOKEN)}`;
      const res=await fetch(url); const text=await res.text();
      if(!res.ok){ custBody.innerHTML=`<tr><td colspan="6" class="error">HTTP ${res.status}<br>${text.slice(0,200)}</td></tr>`; return; }
      if(text==='UNAUTHORIZED'){ custBody.innerHTML=`<tr><td colspan="6" class="error">UNAUTHORIZED — check ADMIN_TOKEN.</td></tr>`; return; }
      const data=JSON.parse(text); const rows=(data&&data.rows)?data.rows:[];
      if(!rows.length){ custBody.innerHTML=`<tr><td colspan="6" class="muted" style="padding:18px">No companies yet.</td></tr>`; return; }
      custBody.innerHTML=rows.map(r=>`<tr>
        <td>${r.company||''}</td>
        <td><code>${r.agent_code||''}</code></td>
        <td><code>${r.supervisor_code||''}</code></td>
        <td><code>${r.admin_code||''}</code></td>
        <td>${String(r.active).toLowerCase()!=='false'?'Yes':'No'}</td>
        <td>${r.created_ts||''}</td>
      </tr>`).join('');
    }catch(e){ custBody.innerHTML=`<tr><td colspan="6" class="error">Network error while loading customers.</td></tr>`; }
  }

  // --- Logs ---
  const tbody=document.getElementById('tbody'), rowCount=document.getElementById('rowCount');
  const typeFilter=document.getElementById('typeFilter'), courseFilter=document.getElementById('courseFilter'), search=document.getElementById('search');

  document.getElementById('refresh').onclick=loadLogs;
  document.getElementById('downloadCsv').onclick=()=>{
    const a=document.createElement('a');
    a.href=`${SCRIPT_URL}?mode=csv&token=${encodeURIComponent(ADMIN_TOKEN)}&limit=5000`;
    a.download='training_logs.csv';
    a.click();
  };

  let allRows=[];
  function fmtEST(isoLike){
    if(!isoLike) return '';
    const d = new Date(isoLike);
    try{
      return new Intl.DateTimeFormat('en-US',{
        timeZone:'America/New_York',
        month:'numeric', day:'numeric', year:'2-digit',
        hour:'numeric', minute:'2-digit', hour12:true
      }).format(d) + ' EST';
    }catch(_){ return String(isoLike); }
  }
  function prettyVideoCell(r){
    if(!r || r.type!=='completion' || !r.videos_json) return '—';
    try{
      const obj = typeof r.videos_json === 'string' ? JSON.parse(r.videos_json) : r.videos_json;
      if (obj && obj.title) return obj.title;
    }catch(_){}
    return '—';
  }

  async function loadLogs(){
    tbody.innerHTML=`<tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr>`;
    try{
      const url=`${SCRIPT_URL}?mode=json&token=${encodeURIComponent(ADMIN_TOKEN)}&limit=2000`;
      const res=await fetch(url); const text=await res.text();
      if(!res.ok){ tbody.innerHTML=`<tr><td colspan="6" class="error">HTTP ${res.status}<br>${text.slice(0,200)}</td></tr>`; return; }
      if(text==='UNAUTHORIZED'){ tbody.innerHTML=`<tr><td colspan="6" class="error">UNAUTHORIZED — token mismatch.</td></tr>`; return; }
      const data=JSON.parse(text); allRows=(data&&data.rows)?data.rows:[];
      renderLogs();
    }catch(e){ tbody.innerHTML=`<tr><td colspan="6" class="error">Failed to load logs.</td></tr>`; }
  }

  function renderLogs(){
    const t=s=>(s==null||s==="")?"":String(s);
    const q=search.value.trim().toLowerCase(), tf=typeFilter.value.trim().toLowerCase(), cf=courseFilter.value.trim().toLowerCase();
    const rows=allRows.filter(r=>{
      const okType=!tf||t(r.type).toLowerCase()===tf;
      const okCourse=!cf||t(r.course).toLowerCase().includes(cf);
      const text=(t(r.name)+" "+t(r.company)+" "+prettyVideoCell(r)).toLowerCase();
      return okType&&okCourse&&(!q||text.includes(q));
    });
    rowCount.textContent=String(rows.length);
    if(!rows.length){tbody.innerHTML=`<tr><td colspan="6" class="muted" style="padding:18px">No rows.</td></tr>`;return;}
    tbody.innerHTML=rows.map(r=>`<tr>
      <td>${fmtEST(r.ts_server)}</td>
      <td>${r.type||''}</td>
      <td>${r.name||''}</td>
      <td>${r.course||''}</td>
      <td>${r.company||''}</td>
      <td>${prettyVideoCell(r)}</td>
    </tr>`).join('');
  }

  typeFilter.addEventListener('change',renderLogs);
  courseFilter.addEventListener('input',renderLogs);
  search.addEventListener('input',renderLogs);
  </script>
</body>
</html>
